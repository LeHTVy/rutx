"""
Post-Exploitation Agent - Phase 5
==================================

Specializes in privilege escalation, lateral movement, persistence.
Tools: mimikatz, bloodhound, linpeas, winpeas, sliver
"""
from typing import Dict, Any, List
from .base_agent import BaseAgent


class PostExploitAgent(BaseAgent):
    """
    Agent for Phase 5: Post-Exploitation.
    
    PTES Phase 5 Goals:
    - Privilege escalation (linpeas, winpeas)
    - Credential extraction (mimikatz)
    - Active Directory analysis (bloodhound)
    - Lateral movement
    - Persistence
    """
    
    # Keywords that trigger this agent
    POSTEXPLOIT_KEYWORDS = [
        "post-exploit", "postexploit", "priv esc", "privilege escalation",
        "mimikatz", "bloodhound", "linpeas", "winpeas", "lateral",
        "persistence", "backdoor", "maintain access", "pivot",
        "escalate", "credential", "dump", "hash", "sliver", "cobalt"
    ]
    
    def __init__(self, llm=None):
        super().__init__(llm)
        self.name = "postexploit"
        self.description = "Privilege escalation, lateral movement, and persistence"
        
        # Phase 5 tools
        self.specialized_tools = [
            # Privilege Escalation
            "linpeas",        # Linux priv esc
            "winpeas",        # Windows priv esc
            
            # Credential Extraction  
            "mimikatz",       # Windows creds
            
            # Active Directory
            "bloodhound",     # AD analysis
            "crackmapexec",   # Network pentesting (specs/brute.py)
            
            # C2 / Persistence (if available)
            "sliver",
            "covenant",
        ]
        
        self.pentest_phases = [5]  # Post-exploitation phase
        
        self.keywords = self.POSTEXPLOIT_KEYWORDS
    
    def can_handle(self, phase: int, query: str) -> bool:
        """Check if this agent should handle the query."""
        if phase == 5:
            return True
        return any(kw in query.lower() for kw in self.POSTEXPLOIT_KEYWORDS)
    
    def plan(self, query: str, context: Dict[str, Any]) -> Dict[str, Any]:
        """Plan post-exploitation tools and actions."""
        tools = self._select_tools(query, context)
        commands = self._get_suggested_commands(tools, context)
        
        return {
            "agent": self.name,
            "tools": tools,
            "commands": commands,
            "reasoning": f"Phase 5 (Post-Exploitation): Selected {', '.join(tools)} for privilege escalation/lateral movement"
        }
    
    def _classify_postexploit_type(self, query: str, context: Dict[str, Any]) -> str:
        """
        Classify post-exploitation task type using LLM intelligence.
        
        NO HARDCODED KEYWORDS - LLM decides based on semantic understanding.
        """
        from app.agent.prompts import format_prompt
        from app.llm.client import OllamaClient
        
        target_os = context.get("target_os", "unknown")
        shell_obtained = context.get("shell_obtained", False)
        
        try:
            prompt = format_prompt(
                "classify_postexploit",
                query=query,
                target_os=target_os,
                shell_obtained=shell_obtained
            )
            
            llm = OllamaClient()
            response = llm.generate(prompt, timeout=10, stream=False).strip().lower()
            
            # Extract valid postexploit type
            valid_types = ["privesc", "creds", "ad_analysis", "lateral", "persistence", "general_postexploit"]
            for pe_type in valid_types:
                if pe_type in response:
                    return pe_type
            
        except Exception as e:
            print(f"  âš ï¸ LLM classification failed: {e}")
        
        return "general_postexploit"
    
    def _select_tools(self, query: str, context: Dict[str, Any]) -> List[str]:
        """Select post-exploitation tools based on context."""
        task_type = self._classify_postexploit_type(query, context)
        tools = []
        
        # Detect OS from context if available
        os_type = context.get("target_os", "unknown").lower()
        
        if task_type == "privesc":
            if "windows" in os_type:
                tools.append("winpeas")
            elif "linux" in os_type:
                tools.append("linpeas")
            else:
                # Unknown OS - suggest both
                tools.extend(["linpeas", "winpeas"])
                
        elif task_type == "creds":
            if "windows" in os_type or self.registry.is_available("mimikatz"):
                tools.append("mimikatz")
            tools.append("crackmapexec")
            
        elif task_type == "ad_analysis":
            if self.registry.is_available("bloodhound"):
                tools.append("bloodhound")
            tools.append("crackmapexec")
            
        elif task_type == "lateral":
            tools.append("crackmapexec")
            
        elif task_type == "general_postexploit":
            # General post-exploit
            if "windows" in os_type:
                tools.extend(["winpeas", "mimikatz"])
            else:
                tools.append("linpeas")
        
        return tools
    
    def _get_suggested_commands(self, tools: List[str], context: Dict[str, Any]) -> Dict[str, str]:
        """Get recommended commands for selected tools."""
        commands = {}
        
        for tool in tools:
            if tool == "crackmapexec":
                commands[tool] = "smb"
            elif tool == "bloodhound":
                commands[tool] = "collect"
            # linpeas/winpeas typically run as scripts
        
        return commands
    
    def analyze_results(self, results: Dict[str, Any], context: Dict[str, Any]) -> str:
        """Analyze post-exploitation results."""
        analysis = []
        
        for tool, result in results.items():
            if not result.get("success"):
                continue
            
            output = result.get("output", "")
            
            if tool in ["linpeas", "winpeas"]:
                if "99%" in output or "95%" in output:
                    analysis.append("ğŸ”´ High-confidence privilege escalation vector found!")
                elif "CVE" in output:
                    analysis.append("âš ï¸ Potential kernel exploit available")
                    
            elif tool == "mimikatz":
                if "NTLM" in output or "Password" in output:
                    analysis.append("ğŸ”‘ Credentials extracted successfully!")
                    
            elif tool == "bloodhound":
                analysis.append("ğŸ“Š Active Directory data collected")
                analysis.append("  â†’ Import .json files into BloodHound GUI for analysis")
                
            elif tool == "crackmapexec":
                if "Pwn3d!" in output:
                    analysis.append("ğŸ¯ Admin access confirmed on target!")
        
        if not analysis:
            analysis.append("â„¹ï¸ Post-exploitation in progress")
        
        analysis.append("\nâ†’ Next: Move to Phase 6 - Reporting")
        
        return "\n".join(analysis)
