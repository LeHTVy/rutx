"""
Web Pentest Agent - Web Application Security Specialist
=======================================================

Handles web vulnerability scanning, fuzzing, and analysis.
"""
from typing import Dict, Any, List, Optional
import logging

from .base import BaseSpecializedAgent, AgentResult, ToolResult

logger = logging.getLogger(__name__)


class WebPentestAgent(BaseSpecializedAgent):
    """
    Web application penetration testing agent.
    
    Specializes in:
    - Directory/endpoint discovery
    - Web vulnerability scanning
    - OWASP Top 10 testing
    - Configuration analysis
    """
    
    ROLE_NAME = "web_pentest_agent"
    
    def execute(self, task: str, context: Dict = None) -> AgentResult:
        """Execute web pentest task"""
        context = context or {}
        context['user_input'] = task
        
        target = context.get('target', '')
        endpoints = context.get('endpoints', [])
        context['endpoints'] = endpoints
        
        findings = {
            "target": target,
            "directories": [],
            "vulnerabilities": [],
            "configurations": []
        }
        tool_results = []
        
        # Directory fuzzing
        if any(kw in task.lower() for kw in ['fuzz', 'dir', 'directory', 'path']):
            if self.can_use_tool('ffuf'):
                result = self.execute_tool('ffuf', 'directory_fuzz', {
                    'url': target if target.startswith('http') else f"http://{target}",
                    'wordlist': '/usr/share/wordlists/dirb/common.txt'
                })
                tool_results.append(result)
                if result.success:
                    findings['directories'] = self._parse_ffuf_output(result.output)
        
        # Vulnerability scanning with nuclei
        if any(kw in task.lower() for kw in ['vuln', 'scan', 'nuclei', 'security']):
            if self.can_use_tool('nuclei'):
                result = self.execute_tool('nuclei', 'scan', {
                    'target': target
                })
                tool_results.append(result)
                if result.success:
                    findings['vulnerabilities'] = self._parse_nuclei_output(result.output)
        
        # Web server analysis
        if any(kw in task.lower() for kw in ['nikto', 'server', 'config']):
            if self.can_use_tool('nikto'):
                result = self.execute_tool('nikto', 'scan', {
                    'host': target
                })
                tool_results.append(result)
                if result.success:
                    findings['configurations'] = self._parse_nikto_output(result.output)
        
        # Generate analysis
        user_prompt = self.get_user_prompt(context)
        analysis = self._generate_llm_response(user_prompt)
        
        return AgentResult(
            agent_name=self.name,
            success=len(tool_results) > 0,
            output=analysis,
            findings=findings,
            tool_results=tool_results,
            next_action="exploit" if findings.get('vulnerabilities') else None,
            suggested_agents=["vuln_hunter_agent", "exploit_expert_agent"]
        )
    
    def _parse_ffuf_output(self, output: str) -> List[Dict]:
        """Parse ffuf directory fuzzing output"""
        dirs = []
        for line in output.split('\n'):
            if 'Status:' in line or '[Status:' in line:
                dirs.append({"raw": line.strip()})
        return dirs
    
    def _parse_nuclei_output(self, output: str) -> List[Dict]:
        """Parse nuclei vulnerability output"""
        vulns = []
        for line in output.split('\n'):
            line = line.strip()
            if line and ('[' in line or 'CVE' in line.upper()):
                vulns.append({"raw": line})
        return vulns
    
    def _parse_nikto_output(self, output: str) -> List[Dict]:
        """Parse nikto configuration analysis"""
        configs = []
        for line in output.split('\n'):
            if line.strip().startswith('+'):
                configs.append({"finding": line.strip()})
        return configs
    
    def suggest_next_agent(self, findings: Dict) -> Optional[str]:
        """Suggest next agent based on web findings"""
        if findings.get('vulnerabilities'):
            return "exploit_expert_agent"
        return "vuln_hunter_agent"
