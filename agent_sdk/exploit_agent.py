"""
ExploitAgent - Vulnerability & Exploitation Specialist for SNODE AI
Handles vulnerability scanning, exploitation, and security assessment
"""

from typing import Dict, Any, Optional
import sys
import os

# Add parent directory to path
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from agent_sdk.base_agent import BaseAgent
from tools import ALL_TOOLS


class ExploitAgent(BaseAgent):
    """
    Exploitation specialist agent
    
    Responsibilities:
    - Vulnerability scanning (nmap vuln scripts)
    - Security assessment
    - Exploitation analysis
    - Risk evaluation
    
    Hands off to FlagAgent after finding vulnerabilities
    """
    
    def __init__(self):
        # Filter tools relevant to exploitation
        exploit_tools = [
            tool for tool in ALL_TOOLS
            if any(keyword in tool['function']['name'].lower() 
                   for keyword in ['vuln', 'aggressive', 'exploit', 'shodan'])
        ]
        
        super().__init__(
            name="ExploitAgent",
            instructions="""You are ExploitAgent, a vulnerability assessment specialist for penetration testing.

Your responsibilities:
1. Vulnerability scanning using nmap NSE scripts
2. Security assessment and risk evaluation
3. Identifying exploitable weaknesses
4. Shodan integration for threat intelligence

Execute Phase 2 (Execution) and Phase 3 (Analysis).
After identifying vulnerabilities, handoff to FlagAgent for flag extraction.""",
            tools=exploit_tools
        )
    
    def run_phase(self, phase: int, user_input: str, context: Optional[Dict] = None) -> Dict[str, Any]:
        """
        Execute exploitation phase
        
        Phase 2: Vulnerability scanning
        Phase 3: Analysis and reporting
        """
        from tools import execute_tool
        from config import OLLAMA_ENDPOINT, MODEL_NAME, TIMEOUT_OLLAMA
        import requests
        
        context = context or {}
        
        if phase == 2:
            # Phase 2: Execute vulnerability scans
            self.add_message("system", "Phase 2: Executing vulnerability scans")
            
            # Get targets from context (from ReconAgent)
            recon_results = context.get("recon_results", [])
            
            if not recon_results:
                # No recon data, scan the original target
                print(f"  ‚ö†Ô∏è  No recon data found, scanning original target")
                targets = [user_input] if user_input else []
            else:
                # Extract targets from recon results
                targets = []
                for result in recon_results:
                    if result.get("tool") == "amass_enum":
                        # Get subdomains from amass
                        result_data = result.get("result", {})
                        if isinstance(result_data, dict):
                            subdomains = result_data.get("subdomains", [])
                            targets.extend(subdomains[:5])  # Limit to top 5
            
            if not targets:
                self.add_message("assistant",
                               "No targets found for vulnerability scanning")
                context["vuln_results"] = []
                context["completed_phases"] = context.get("completed_phases", []) + [2]
                self.current_phase = 3
                return {"context": context}
            
            # Run vulnerability scans
            results = []
            for target in targets[:3]:  # Limit to 3 targets
                print(f"  üîç Vuln scanning: {target}")
                
                try:
                    result = execute_tool("nmap_vuln_scan", {
                        "target": target,
                        "timeout": 300
                    })
                    results.append({
                        "target": target,
                        "result": result
                    })
                except Exception as e:
                    print(f"  ‚ö†Ô∏è  Scan failed: {e}")
                    results.append({
                        "target": target,
                        "error": str(e)
                    })
            
            # Store results
            context["vuln_results"] = results
            context["completed_phases"] = context.get("completed_phases", []) + [2]
            
            self.add_message("assistant",
                           f"Vulnerability scanning complete. Scanned {len(results)} targets.")
            
            # Move to phase 3
            self.current_phase = 3
            return {"context": context}
        
        elif phase == 3:
            # Phase 3: Analyze vulnerabilities
            self.add_message("system", "Phase 3: Analyzing vulnerabilities")
            
            vuln_results = context.get("vuln_results", [])
            
            if not vuln_results:
                self.add_message("assistant", "No vulnerability data to analyze")
                
                # Still handoff to FlagAgent
                from agent_sdk.flag_agent import FlagAgent
                next_agent = FlagAgent()
                
                return {
                    "handoff_to": next_agent,
                    "handoff_context": context,
                    "message": "No vulnerabilities found, handing off to FlagAgent"
                }
            
            # Use LLM to analyze vulnerabilities
            system_prompt = self.get_system_prompt()
            messages = self.message_history.get_history_for_llm()
            
            # Add vulnerability results
            vuln_summary = f"Found {len(vuln_results)} vulnerability scan results:\\n"
            for r in vuln_results:
                target = r.get("target")
                if "error" in r:
                    vuln_summary += f"- {target}: Error - {r['error']}\\n"
                else:
                    vuln_summary += f"- {target}: Scan complete\\n"
            
            messages.append({
                "role": "system",
                "content": vuln_summary
            })
            
            try:
                response = requests.post(
                    OLLAMA_ENDPOINT,
                    json={
                        "model": MODEL_NAME,
                        "messages": messages,
                        "stream": False
                    },
                    timeout=TIMEOUT_OLLAMA
                )
                
                if response.status_code == 200:
                    result = response.json()
                    analysis = result.get("message", {}).get("content", "Analysis unavailable")
                    
                    self.add_message("assistant", analysis)
                    context["exploit_analysis"] = analysis
                
            except Exception as e:
                print(f"  ‚ö†Ô∏è  LLM analysis failed: {e}")
                context["exploit_analysis"] = "Analysis failed"
            
            context["completed_phases"] = context.get("completed_phases", []) + [3]
            
            # Handoff to FlagAgent
            from agent_sdk.flag_agent import FlagAgent
            next_agent = FlagAgent()
            
            return {
                "handoff_to": next_agent,
                "handoff_context": context,
                "message": "Vulnerability analysis complete, handing off to FlagAgent"
            }
        
        else:
            raise ValueError(f"ExploitAgent does not handle phase {phase}")


if __name__ == "__main__":
    # Test ExploitAgent
    print("üß™ Testing ExploitAgent\\n")
    
    agent = ExploitAgent()
    print(f"Agent: {agent}")
    print(f"Tools: {len(agent.tools)} exploit tools available")
    
    # Show some tools
    for tool in agent.tools[:3]:
        print(f"  - {tool['function']['name']}")
    
    print(f"\\n‚úÖ ExploitAgent initialized successfully!")
